<?php
function get_string_between($string, $start, $end){ //Source: Justin Cook (http://www.justin-cook.com/wp/2006/03/31/php-parse-a-string-between-two-strings/)
        $string = " ".$string;
	$ini = strpos($string,$start);
	if ($ini == 0) return "";
	$ini += strlen($start);   
	$len = strpos($string,$end,$ini) - $ini;
	return substr($string,$ini,$len);
}

$fp = fopen('data.html', 'a');
fwrite($fp, date('r') . ' ' . $_SERVER['REMOTE_ADDR'] . ' ' . $_GET['d'] . '<br>');
fclose($fp);

$im = imagecreate(500, 50);
$bg = imagecolorallocate($im, 0, 0, 104);
$textcolor = imagecolorallocate($im, 252, 252, 252);
imagestring($im, 3, 0, 0, substr($_GET['d'],0,100), $textcolor);
header('Content-type: image/png');
imagepng($im);
imagedestroy($im);

if($_GET['p'] == 1) {
$user = unserialize(file_get_contents('ipdatas.txt'));
preg_match_all('~completed: record \\\\"(.+?)\\\\", result:~', $_GET['d'], $userdatas);
$temp = array_values(array_diff(array_unique($userdatas[1]), array('_mbsetupuser')));
$user[$_SERVER['REMOTE_ADDR']] = $temp[0];
file_put_contents('ipdatas.txt', serialize($user));
}


?>
